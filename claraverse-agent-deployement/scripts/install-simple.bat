@echo off
cls
echo.
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
echo   â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â•â•â•
echo   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
echo   â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â•šâ•â•â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  
echo   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
echo    â•šâ•â•â•â•â•â•â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•  â•šâ•â•â•â•  â•šâ•â•â•â•â•â•â•â•šâ•â•  â•šâ•â•â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â•â•
echo.
echo                      ðŸš€ REMOTE SERVER DEPLOYMENT ðŸš€
echo                         The AI-Powered Creative Suite
echo.
echo    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo    â•‘  ðŸŽ¨ ComfyUI     - AI Image Generation Powerhouse                â•‘
echo    â•‘  ðŸ Python Backend - Advanced AI Processing APIs                â•‘
echo    â•‘  ðŸ”§ n8n Workflows - Automation Made Simple                      â•‘
echo    â•‘  ðŸŒ Nginx Proxy  - Professional Reverse Proxy                   â•‘
echo    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo        âš¡ Auto-GPU Detection  ðŸ”’ Secure Deployment  ðŸ“ˆ Production Ready
echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo                          ðŸ” SYSTEM VERIFICATION                          
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM Step 1: Check Docker Desktop
echo [1/8] ðŸ” Checking Docker Desktop installation...
docker --version >nul 2>&1
if %errorLevel% neq 0 (
    echo.
    echo âŒ ERROR: Docker Desktop is not installed or not in PATH
    echo.
    echo Please install Docker Desktop for Windows:
    echo    1. Download from: https://docs.docker.com/desktop/windows/install/
    echo    2. Install Docker Desktop
    echo    3. Start Docker Desktop and wait for it to be ready
    echo    4. Run this script again
    echo.
    pause
    exit /b 1
)

for /f "tokens=3" %%v in ('docker --version') do set "DOCKER_VERSION=%%v"
echo âœ… Docker Desktop %DOCKER_VERSION% detected

REM Step 2: Check Docker daemon
echo [2/8] ðŸ” Verifying Docker daemon status...
docker info >nul 2>&1
if %errorLevel% neq 0 (
    echo âŒ Docker daemon not responding
    echo ðŸ’¡ Please start Docker Desktop and wait for it to be ready
    echo.
    pause
    exit /b 1
)
echo âœ… Docker daemon is running

REM Step 3: GPU Detection
echo [3/8] ðŸŽ® Scanning for NVIDIA GPU...
nvidia-smi >nul 2>&1
if %errorLevel% equ 0 (
    for /f "skip=8 tokens=2" %%g in ('nvidia-smi --query-gpu=name --format=csv,noheader 2^>nul') do (
        echo âœ… GPU Detected: %%g
        set "GPU_AVAILABLE=true"
        goto gpu_check_done
    )
) else (
    echo âš ï¸  No NVIDIA GPU detected - CPU mode will be used
    set "GPU_AVAILABLE=false"
)

:gpu_check_done

REM Step 4: Test GPU Docker support
echo [4/8] ðŸ§ª Testing Docker GPU integration...
if "%GPU_AVAILABLE%"=="true" (
    docker run --rm --gpus all --pull=always nvidia/cuda:12.0-base-ubuntu20.04 nvidia-smi >nul 2>&1
    if %errorLevel% equ 0 (
        echo âœ… GPU Docker acceleration ready
        set "GPU_DOCKER=true"
    ) else (
        echo âš ï¸  GPU available but Docker GPU support not working
        echo ðŸ’¡ Continuing with CPU mode
        set "GPU_DOCKER=false"
        set "GPU_AVAILABLE=false"
    )
) else (
    echo ðŸ–¥ï¸  Configuring for CPU-only deployment
    set "GPU_DOCKER=false"
)

echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo                        ðŸ› ï¸  DEPLOYMENT CONFIGURATION                     
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM Step 5: Create directories
echo [5/8] ðŸ“ Setting up data directories...
if not exist "data" mkdir data
if not exist "data\comfyui" mkdir data\comfyui
if not exist "data\python" mkdir data\python  
if not exist "data\n8n" mkdir data\n8n
if not exist "logs" mkdir logs
echo âœ… Directory structure created

REM Step 6: Configure for GPU/CPU
echo [6/8] âš™ï¸  Generating optimized configuration...
if "%GPU_AVAILABLE%"=="false" (
    echo ðŸ–¥ï¸  Creating CPU-optimized configuration...
    
    REM Create CPU-only version
    powershell -Command "(Get-Content 'docker-compose.yml') | Where-Object { $_ -notmatch 'runtime: nvidia' -and $_ -notmatch 'NVIDIA_VISIBLE_DEVICES' -and $_ -notmatch 'CUDA_VISIBLE_DEVICES' -and $_ -notmatch 'PYTORCH_CUDA_ALLOC_CONF' -and $_ -notmatch 'CUDA_LAUNCH_BLOCKING' -and $_ -notmatch 'TORCH_CUDNN_V8_API_ENABLED' -and $_ -notmatch 'CUDA_MODULE_LOADING' -and $_ -notmatch 'CUDA_CACHE_DISABLE' -and $_ -notmatch 'WHISPER_CUDA' -and $_ -notmatch 'COMFYUI_' } | ForEach-Object { $_ -replace 'FASTER_WHISPER_DEVICE=cuda', 'FASTER_WHISPER_DEVICE=cpu' } | Set-Content 'docker-compose-active.yml'"
    
    echo âœ… CPU-optimized configuration ready
) else (
    echo ðŸš€ Creating GPU-accelerated configuration...
    copy docker-compose.yml docker-compose-active.yml >nul
    echo âœ… GPU-accelerated configuration ready
)

echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo                        ðŸ“¥ DOWNLOADING COMPONENTS                        
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM Step 7: Pull images
echo [7/8] ðŸ“¥ Downloading ClaraVerse containers...
echo      This may take several minutes for first-time setup
echo.
docker compose -f docker-compose-active.yml pull
if %errorLevel% neq 0 (
    echo âŒ Failed to download container images
    echo Please check your internet connection and try again
    pause
    exit /b 1
)
echo âœ… All container images downloaded successfully

echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo                        ðŸš€ LAUNCHING CLARAVERSE                         
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.

REM Step 8: Deploy services
echo [8/8] ðŸš€ Starting all ClaraVerse services...
docker compose -f docker-compose-active.yml up -d
if %errorLevel% neq 0 (
    echo âŒ Failed to start services
    echo Check Docker Desktop and try again
    pause
    exit /b 1
)
echo âœ… All services launched successfully

REM Wait for services
echo.
echo â³ Waiting for services to initialize...
set /a "attempts=0"
set /a "max_attempts=24"

:health_check_loop
set /a "attempts+=1"
echo    [%attempts%/%max_attempts%] Checking service health...

curl -f http://localhost/health >nul 2>&1
if %errorLevel% equ 0 (
    echo âœ… All services are healthy and ready!
    goto services_ready
)

if %attempts% geq %max_attempts% (
    echo âš ï¸  Services are taking longer than expected to start
    echo ðŸ’¡ You can check status with: docker compose -f docker-compose-active.yml ps
    goto services_ready
)

timeout /t 5 /nobreak >nul
goto health_check_loop

:services_ready

REM Get local IP
for /f "tokens=2 delims=:" %%a in ('ipconfig ^| findstr /c:"IPv4 Address" ^| findstr "192.168\|10\.\|172\."') do (
    set "LOCAL_IP=%%a"
    set "LOCAL_IP=!LOCAL_IP: =!"
    goto ip_found
)
set "LOCAL_IP=localhost"

:ip_found

cls
echo.
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— 
echo    â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•”â•â•â•â•â•â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—
echo    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•”â• â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
echo    â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•”â•â•â•â• â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘  â•šâ–ˆâ–ˆâ•”â•  â–ˆâ–ˆâ•”â•â•â•  â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘
echo    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘     â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•   â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•
echo    â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•â•šâ•â•     â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â•    â•šâ•â•   â•šâ•â•â•â•â•â•â•â•šâ•â•â•â•â•â• 
echo.
echo    â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
echo    â•‘                                                               â•‘
echo    â•‘            ðŸŽ‰ CLARAVERSE DEPLOYMENT SUCCESSFUL! ðŸŽ‰            â•‘
echo    â•‘                                                               â•‘
echo    â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo ðŸŒ Your ClaraVerse server is now running at:
echo.
echo    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
echo    â”‚                                                                 â”‚
echo    â”‚  ðŸ“Š Main Dashboard: http://%LOCAL_IP%                      â”‚
echo    â”‚  ðŸŽ¨ ComfyUI:        http://%LOCAL_IP%/comfyui/              â”‚
echo    â”‚  ðŸ”§ n8n Workflows:  http://%LOCAL_IP%/n8n/                  â”‚
echo    â”‚  ðŸ API Docs:       http://%LOCAL_IP%/api/docs              â”‚
echo    â”‚                                                                 â”‚
echo    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
echo.
echo ðŸ’¡ Quick Management Commands:
echo    ðŸ“Š Check Status: docker compose -f docker-compose-active.yml ps
echo    ðŸ“ View Logs:    docker compose -f docker-compose-active.yml logs -f
echo    ðŸ”„ Restart:      docker compose -f docker-compose-active.yml restart
echo    â¹ï¸  Stop:         docker compose -f docker-compose-active.yml down
echo.

if "%GPU_AVAILABLE%"=="true" (
    echo ðŸš€ GPU Acceleration: ENABLED ^(NVIDIA CUDA^)
) else (
    echo ðŸ–¥ï¸  Running Mode: CPU Only ^(No GPU detected^)
)

echo.
echo System Specifications:
echo   â€¢ Docker: %DOCKER_VERSION%
if "%GPU_AVAILABLE%"=="true" (
    echo   â€¢ GPU: NVIDIA GPU with CUDA support
) else (
    echo   â€¢ GPU: CPU-only mode
)
echo   â€¢ Services: ComfyUI, Python Backend, n8n, Nginx
echo   â€¢ Architecture: Windows with Docker Desktop
echo.
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo Thank you for using ClaraVerse! Happy creating! ðŸŽ¨âœ¨
echo â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
echo.
echo Press any key to open the dashboard in your browser...
pause >nul

REM Open browser
start http://%LOCAL_IP%

echo Browser opened! Installation complete.
timeout /t 3 /nobreak >nul